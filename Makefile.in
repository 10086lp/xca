#
#  @configure_input@
#
# $Id$
#

VERSION=@PACKAGE_VERSION@
TAG=$(shell echo "V.$(VERSION)" |sed "s/\./_/g" )
TARGET=xca-$(VERSION)

GCC=@CXX@
CPPFLAGS=@CPPFLAGS@ -Wall -ggdb

LIBS=-Llib @LDFLAGS@ @LIBS@ -lxcadb -lpki
MOC=@MOC@
UIC=@UIC@


###################################

OBJS=NewKey_UI.o NewKey_UI_MOC.o \
     KeyDetail_UI.o KeyDetail_UI_MOC.o \
     ReqDetail_UI.o ReqDetail_UI_MOC.o \
     MainWindow_UI.o MainWindow_UI_MOC.o \
     PassRead_UI.o PassRead_UI_MOC.o \
     PassWrite_UI.o PassWrite_UI_MOC.o \
     ExportKey_UI.o ExportKey_UI_MOC.o \
     NewX509Req_UI.o NewX509Req_UI_MOC.o \
     NewX509_0_UI.o NewX509_0_UI_MOC.o \
     NewX509_1_UI.o NewX509_1_UI_MOC.o \
     NewX509_2_UI.o NewX509_2_UI_MOC.o \
     NewX509_3_UI.o NewX509_3_UI_MOC.o \
     NewX509.o NewX509_MOC.o \
     NewX509_0.o NewX509_0_MOC.o \
     CertDetail_UI.o CertDetail_UI_MOC.o \
     Rename_UI.o Rename_UI_MOC.o \
     ExportKey.o ExportKey_MOC.o \
     TrustState_UI.o TrustState_UI_MOC.o \
     MainWindow.o MainWindow_MOC.o \
     MainWindowKeys.o MainWindowX509Req.o MainWindowX509.o \
     main.o

all: libs $(OBJS) xca
	@echo -e "\n\n*****************************************************************\n* If you have comments, compilingproblems, bugs or suggestions, *\n* don't hesitate to contact me at: christian@hohnstaedt.de      *\n*****************************************************************\n"

re: clean all

MainWindow.h: MainWindow_UI.h KeyDetail_UI.h \
	      PassRead_UI.h PassWrite_UI.h ExportKey_UI.h \
	      NewX509Req_UI.h NewKey_UI.h ReqDetail_UI.h \
	      NewX509_0_UI.h CertDetail_UI.h NewX509_1_UI.h NewX509.h \
	      NewX509_2_UI.h NewX509_3_UI.h Rename_UI.h TrustState_UI.h

%.o: %.cpp
	$(GCC) $(CPPFLAGS) -DVER=\"$(VERSION)\" -DPREFIX=\"@prefix@/share/xca\" -c $< -o $@

%_MOC.cpp: %.h
	$(MOC) $< -o $@

NewX509_%.mui:	NewX509_%.ui
	cat $< | sed s/QDialog/NewX509/ > $@

%.mui:	%.ui
	cp $< $@

NewX509_%_UI.h: NewX509_%.mui NewX509.h
	echo '#include "NewX509.h"' > $@
	$(UIC) $< >> $@
#	 
#NewX509_%_UI.cpp: NewX509_%_UI.h NewX509_%.mui
#	$(UIC) -o $@ -subimpl NewX509 $^

%_UI.h: %.mui
	$(UIC) -o $@ $<
	 
%_UI.cpp: %_UI.h %.mui
	$(UIC) -o $@ -impl $^

xca: $(OBJS) lib/libxcadb.a lib/libpki.a
	$(GCC) $(CPPFLAGS) $(INC) $(LPATH) $(OBJS) $(LIBS) -o xca

libs:
	make -C lib all

clean:
	make -C lib clean
	rm -rf *_MOC.cpp *_UI.h *_UI.cpp *~ *.o xca 

distclean: clean	
	make -C lib distclean
	rm -f Makefile config.cache config.h

dist: 
	rm -rf ../$(TARGET)
	cvs export -r $(TAG) -d ../$(TARGET) xca
	rcs2log >> ../$(TARGET)/CHANGELOG 
	(cd ../$(TARGET); autoconf; lrelease xca.pro; cat rpm/xca.spec |sed s/VERSION/$(VERSION)/g >rpm/$(TARGET)-1.spec; rm rpm/xca.spec )
	(cd ..; tar zcf $(TARGET).tar.gz $(TARGET) )
	rm -rf ../$(TARGET)
	
install: xca
	strip xca
	install -m 755 -o root -g root xca $(DESTDIR)@prefix@/bin
	install -m 755 -o root -g root -d $(DESTDIR)@prefix@/share/xca
	install -m 644 -o root -g root img/*.png $(DESTDIR)@prefix@/share/xca
	
