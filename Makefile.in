#
#  @configure_input@
#
# $Id$
#

VERSION=@PACKAGE_VERSION@
TAG=$(shell echo "V.$(TVERSION)" |sed "s/\./_/g" )
TARGET=xca-$(TVERSION)

GCC=@CXX@
CC=@CC@

CPPFLAGS=-I. @CPPFLAGS@ @DEFS@ 
CFLAGS=@ac_CC_WARN@ @ac_DEBUG@

LDFLAGS=@LDFLAGS@
LIBS=@LIBS@

MOC=@MOC@
UIC=@UIC@

###################################

OBJS=ui/ui.o widgets/widgets.o view/view.o lib/libpki.o
SUBDIRS=ui lib widgets view

all: $(SUBDIRS) xca

re: clean all

xca: $(OBJS)
	$(CC) $(LDFLAGS) $(OBJS) $(LIBS) -o xca
	@echo -e "\n\n\nOk, compilation was successfull. \nNow do as root: 'make install'\n"

$(SUBDIRS):
	$(MAKE) -C $@ all

clean:
	for x in $(SUBDIRS); do \
		$(MAKE) -C $${x} clean; \
	done
	rm -f $(MOC_CPP) $(UI_CPP) $(UI_H) *~ *.o xca 

distclean: clean	
	for x in $(SUBDIRS); do \
		$(MAKE) -C $${x} distclean; \
	done
	rm -f Makefile config.cache config.h config.log config.status results
	rm -rf autom4te.cache

dist: 
	test ! -z "$(TVERSION)"
	rm -rf $(TARGET) 
	cvs export -r $(TAG) -d $(TARGET) xca && \
	(cd $(TARGET) &&  autoconf && \
	./mkxcapro.sh && lrelease xca.pro && \
	cat rpm/xca.spec |sed s/VERSION/$(TVERSION)/g >rpm/$(TARGET)-1.spec && \
	cat lib/base.h.win |sed s/VERSION/$(TVERSION)/g >lib/base.h && \
	cat misc/xca.nsi |sed s/VERSION/$(TVERSION)/g >misc/$(TARGET).nsi && \
	rm -rf misc/xca.nsi rpm/xca.spec autom4te.cache && \
	cd doc && linuxdoc -B html xca.sgml || echo "no linuxdoc found -> continuing"; ) && \
	tar zcf $(TARGET).tar.gz $(TARGET) 
	#rm -rf ../$(TARGET)
	
install: xca
	strip xca
	install -m 755 -d $(prefix)@prefix@/share/xca $(prefix)@prefix@/bin \
			$(prefix)@prefix@/share/applications \
			$(prefix)@prefix@/share/pixmaps
	install -m 755 xca $(prefix)@prefix@/bin
	install -m 644 img/*.png $(prefix)@prefix@/share/xca
	install -m 644 img/key.xpm $(prefix)@prefix@/share/pixmaps/xca.xpm
	install -m 644 misc/xca.desktop $(prefix)@prefix@/share/applications
	install -m 644 lang/xca_??.qm $(prefix)@prefix@/share/xca

.PHONY: $(SUBDIRS)
