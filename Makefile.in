#
#  @configure_input@
#
# $Id$
#

VERSION=@PACKAGE_VERSION@
TAG=$(shell echo "V.$(VERSION)" |sed "s/\./_/g" )
TARGET=xca-$(VERSION)

GCC=@CXX@
CPPFLAGS=@CPPFLAGS@ @DEFS@ -Wall -g

LIBS=-Llib @LDFLAGS@ @LIBS@ -lxcadb -lpki
MOC=@MOC@
UIC=@UIC@


###################################

OBJS=NewKey.o moc_NewKey.o \
     KeyDetail.o moc_KeyDetail.o \
     ReqDetail.o moc_ReqDetail.o \
     MainWindow_UI.o moc_MainWindow_UI.o \
     PassRead.o moc_PassRead.o \
     PassWrite.o moc_PassWrite.o \
     ExportKey_UI.o moc_ExportKey_UI.o \
     NewX509_UI.o moc_NewX509_UI.o \
     NewX509.o moc_NewX509.o \
     CertDetail.o moc_CertDetail.o \
     ExportKey.o moc_ExportKey.o \
     TrustState.o moc_TrustState.o \
     MainWindow.o moc_MainWindow.o \
     MainWindowKeys.o MainWindowX509Req.o \
     MainWindowX509.o MainWindowTemps.o \
     main.o


all: libs $(OBJS) xca

re: clean all

MainWindow.h: MainWindow_UI.h KeyDetail.h \
	      PassRead.h PassWrite.h ExportKey_UI.h \
	      NewKey.h ReqDetail.h \
	      CertDetail.h NewX509.h  NewX509_UI.h\
	      TrustState.h

%.o: %.cpp
	$(GCC) $(CPPFLAGS) -DVER=\"$(VERSION)\" -DPREFIX=\"@prefix@/share/xca\" -c $< -o $@

xca: $(OBJS) lib/libxcadb.a lib/libpki.a
	$(GCC) $(CPPFLAGS) $(INC) $(LPATH) $(OBJS) $(LIBS) -o xca
	@echo -e "\n\n\nOk, compilation was successfull. \nNow do as root: 'make install'\n"

libs:
	make -C lib all

clean:
	make -C lib clean
	rm -rf moc_*.cpp *_UI.h *_UI.cpp *~ *.o xca 

distclean: clean	
	make -C lib distclean
	rm -f Makefile config.cache config.h

dist: 
	rm -rf ../$(TARGET)
	cvs export -r $(TAG) -d ../$(TARGET) xca
	(cd ../$(TARGET);  autoconf; \
		./mkxcapro.sh; lrelease xca.pro; \
		cat rpm/xca.spec debian/changelog |sed s/VERSION/$(VERSION)/g >rpm/$(TARGET)-1.spec; \
		rm rpm/xca.spec )
	(cd ..; tar zcf $(TARGET).tar.gz $(TARGET) )
	#rm -rf ../$(TARGET)
	
install: xca
	strip xca
	install -m 755 -o root -g root xca $(DESTDIR)@prefix@/bin
	install -m 755 -o root -g root -d $(DESTDIR)@prefix@/share/xca
	install -m 644 -o root -g root img/*.png $(DESTDIR)@prefix@/share/xca
	install -m 644 -o root -g root xca_??.qm $(DESTDIR)@prefix@/share/xca
	
moc_%.cpp: %.h %.cpp
	$(MOC) $< -o $@

%.h: %.ui
	$(UIC) -o $@ $<
	 
%.cpp: %.h %.ui
	$(UIC) -o $@ -impl $^
